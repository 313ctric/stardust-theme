{% extends "section.html" %}
{% import "macros/events.html" as events %}
{% import "macros/logos.html" as logos %}

{% block header %}
{% set term = get_section(path=resource.ancestors | last) %}
<h1>{{ term.title }}: {{ resource.title | safe }}</h1>
{% endblock %}

{% block get_pages %}
  {{ super() }}
  {% set pages = pages | sort(attribute="date") %}
{% endblock %}


{% block pages %}
<div class="schedule" style="background-color: var(--bs-body-bg, {{ formatters::colour(colour="grey") }}); background-image: url(&quot;{{ get_url(path="assets/bg-particles.png") }}&quot;); background-size: contain; width: 700px" data-bs-theme="dark">
  <style>
    .schedule .dots-uwcs {
      height: 4em;
      margin-top: 1em;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
  </style>

  {{ logos::dots_uwcs(letter="white") }}
  <div class="term blue-top pb-3" data-bs-theme="dark">
    <h1 style="margin-top: -0.5em">{{ resource.title | safe }}</h1>
    {{ events::week(w=resource, pages=pages) }}
  </div>
</div>

{% block script %}
<script>
  function capture() {    
    const options = {
      method: 'POST',
      body: JSON.stringify({
        html: document.children[0].outerHTML.replaceAll("http://127.0.0.1:1111", "https://uwcs.co.uk"),
        css: "",
        selector: "#image"
      }),
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Basic ' + btoa("{{ config.extra.htmltoimg_userid }}:{{ config.extra.htmltoimg_apikey }}")
      }
    }
    
    fetch('https://hcti.io/v1/image', options)
      .then(res => {
        if (res.ok) {
          return res.json();
        } else {
          return Promise.reject(res.status);
        }
      }).then(data => {
        console.log(data.url)
      }).catch(err => console.error(err));
  }

  addEventListener("load", (event) => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("image")) {
      const sch = document.getElementsByClassName("schedule")[0];
      const b = document.getElementsByTagName("body")[0];
      const newsch = b.insertAdjacentElement("afterbegin", sch);
      newsch.width = 690;
      newsch.id = "image";

      while (b.children.length > 1) {
        b.removeChild(b.lastChild);
      }

      capture();
    }
  })
</script>
{{ events::script() }}
  
<button class="btn btn-secondary" onClick="capture()">Save Image</button>
{% endblock %}

{% endblock %}