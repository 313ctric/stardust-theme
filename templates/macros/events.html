
{% import "macros/formatters.html" as formatters %}

{% macro event_circle(e) %}
<a href="{{ e.permalink }}" class="text-decoration-none">
<div class="event-circle mt-0" style="background-color: {{ e.extra.colour }}" data-bs-theme="dark">
{% if e.extra.icon %}
<span class="event-icon">
  {% if e.extra.icon is starting_with("ph-") %}<i class="ph-bold {{ e.extra.icon }}"></i>
  {% elif e.extra.icon is starting_with("bi-") %}<i class="bi {{ e.extra.icon }}"></i>
  {% else %} <div class="icon"><img class="silhouette" src="{{ config.base_url | safe }}/{{ e.extra.icon }}" alt="event icon"></img></div>
  {% endif %}
</span> {% endif %}
<b class="event-title">{{ e.title }}</b>
<span class="event-extras">
  {{ e.extra.location }}<br>
  {{ formatters::event_time(e=e) }}
</span>
</div>
</a>
{% endmacro %}


{% macro day(events) %}
{% if events[0].extra.display_day %}{% set date = events[0].extra.display_day %}
{% else %}{% set date = events[0].date | date(format="%A") %}{% endif %}
<div class="event-outer bg-body rounded-4 text-center text-white" data-event-count="{{ events | length }}">
  {% if date %}
    <h4 class="fw-semibold">{{ date }}</h4>
  {% endif %}
  <div class="day">
    {% for e in events | sort(attribute="date") %}
      {{ events::event_circle(e=e) }}
    {% endfor %}
  </div>
</div>
{% endmacro %}


{% macro week(w, pages) %}
{% set prev_day = "" %}
{% set days_events = [] %}
<div class="week w-100 text-center">
  <div class="events d-grid justify-content-center">
    {% for e in pages %}
      {% if e.extra.display_day %}{% set e_day = e.extra.display_day %}
      {% else %}{% set e_day = e.date | date(format="%A") %}{% endif %}
      {% if e_day != prev_day %}
        {# Output previous day's content #}
        {% if days_events %}
          {{ events::day(events=days_events) }}
          {% set_global days_events = [] %}
          {% set_global started = true %}
        {% endif %}
        {% set_global prev_day = e_day %}
      {% endif %}
      {% set_global days_events = days_events | concat(with=e) %}
    {% endfor %}

      {# Clean up remaining days_events #}
    {% if started %}
      {% if days_events %}
        {{ events::day(events=days_events) }}
      {% endif %}
    {% endif %}
  </div>
</div>
{% endmacro %}


{% macro script() %} 
<script>
  combs = {
    1: [[1, 1]],
    2: [[2, 1], [1, 2]],
    3: [[3, 1], [2, 2], [1, 3]],
    4: [[2, 2]],
    5: [[3, 2], [2, 3]],
    6: [[3, 2], [2, 3]],
  }

  function next_cell(loc, shift = 1) {
    loc[0] += shift;
    if (loc[0] >= cols) {
      loc[0] = 0;
      loc[1] += 1;
    }
  }

  function pack(i, grid, day, loc, cols) {
    if (day.dataset.eventCount > 6) return `day-${cols}-1x${cols}`;
    layouts = combs[day.dataset.eventCount];
    for (var dim of layouts) {
      // console.log(`Trying ${dim}, ${loc}`);
      if (fits(dim, loc, grid, cols)) {
        set_region(i, dim, loc, grid);
        return `day-${cols}-${dim[0]}x${dim[1]}`;
      }
    }
    return undefined;
  }

  function fits(dim, loc, grid, cols) {
    if (loc[0] + dim[0] > cols) return false;

    for (let y = loc[1]; y < loc[1] + dim[1]; y++) {
      if (y >= grid.length) continue;
      for (let x = loc[0]; x < loc[0] + dim[0]; x++) {
        if (grid[y][x] != -1) return false;
      }
    }
    // console.log("Fits");
    return true;
  }

  function set_region(i, dim, loc, grid) {
    // console.log("Filling");
    for (let y = loc[1]; y < loc[1] + dim[1]; y++) {
      if (y >= grid.length) grid.push(Array.from({ length: cols }, () => -1));
      for (let x = loc[0]; x < loc[0] + dim[0]; x++) {

        // console.log("Filling", x, y, i);
        grid[y][x] = i;
      }
    }
    next_cell(loc, dim[0]);
  }

  var week_events = document.getElementsByClassName("events");
  for (var week of week_events) {
    for (var cols of [2, 3]) {
      var grid = Array.from({ length: 3 }, () => Array.from({ length: cols }, () => -1));
      var pos = [0, 0];
      // console.log(`ecols ${cols}`);
      for (const [i, day] of Array.prototype.entries.call(week.children)) {
        // console.log(i, day.dataset.eventCount);
        while (true) {
          let p = pack(i, grid, day, pos, cols);
          if (!p) next_cell(pos);
          else {
            day.classList.add(p);
            break
          }
        }
        // console.log(grid);
      }
    }
  }
</script>
{% endmacro %}